　　２ちゃんねる風スレッドフロート型掲示板
　　　　　Yakumo BBS Script Ver 1.01g(人柱版)

　　          by Kobayashi Yukiharu


　ダウンロードありがとうございます。

　これは人柱版という事で、動作確認をあまりしていません。
　1.01fから変更したファイル、追加したファイルのみを収録しています。
　新機能の使い方はこのテキストで簡単に説明します。

　1.01からバージョンアップをされる場合は、面倒でも全ての人柱版をダウンロードして順番に
上書きして下さい。
　1.01fからのバージョンアップは収録しているファイルを上書きしてアップロードして下さい。
　改造してお使いの場合はあらかじめ改造箇所を変更してから上書きして下さい。

■バージョンアップ内容■
スクリプトの初期化でcgiファイルの１行目がlogin_ownerと同じならファイルを書き換えないように変更
管理画面の一部を変更
規制ログの名称をエラーログに変更
規制設定メニューを階層化
キャップ設定、規制外トリップ設定、エラーログ閲覧編集を規制設定に移動
キャップ、規制外トリップをサーバー単位でも設定できるように変更
「ボード設定変更」で「index.htmlで省略しないレス行数」を０にすると省略しないように変更
AAモードの「字」リンクが文字を表示しなくなっていた不具合を修正
a.cgiから戻るとAAモードを解除してしまう不具合を修正
AASのurlが変更になったのを修正
一部の携帯用２ちゃんねる専用ブラウザからも投稿できるように修正
localhostがipv6の場合無理やりipv4で実行するように変更
リモートホストがau-net.ne.jpの場合は投稿IDをクッキーのデータから生成するようにしました
投稿時のエラーメッセージを別ファイルにしてカスタマイズ可能にしました
規制項目にユーザーエージェント、リライトワードを追加
外部サイトを利用した規制の設定方法を変更
ＮＧワードを名前欄、メール欄、文章欄、スレッドタイトルに個別設定できるように変更
IPアドレス規制にサブネットマスク形式を使えるようにしました
規制に正規表現を使えるようにしました
規制に除外を設定できるように変更
ボードの書き込み制限、スレ立て制限にレベルを選択できるように変更
レベルは０からスタートするように変更
名前欄の!fusianasanや!ninja等の機能を廃止(リライトワードで設定してください)
それに伴いnanja(端末トリップ)が名前欄の設定4以外では規制外トリップと認識されなくなりました
投稿用ボードに在るスレッドと同じ名前のスレッドを立てられないようにしました
IDが１年でリセットされないように生成方法を変更
連投規制、二重投稿規制導入
.htaccessによる自動アクセス制限導入
url設定を.htaccessに定義できるようにした
IE10でボードトップから名前欄、メール欄を空白で投稿するとundefinedの文字が出るのを修正
メンテナンス告知解除にバージョンアップ時の設定更新機能を追加
その他目に付いた不具合を修正


□ご注意□
掲示板設定のID生成に使う文字列に重複チェックを入れましたが、警告を出すだけにしています。
この文字列は重複非推奨ですが、禁止してはいません。
重複している場合は異なる日付で同じIDが表示される場合が有ります。
全て同じ文字にすると、日付が変わってもIDが変わらない固定IDとなります。
クッキー設定の暗号用文字列にも重複チェックを入れました。
こちらは重複しているとまともに動作しないので、重複禁止にしています。

キャップはボード単位でもサーバー単位でも設定できるようになりました。
もし両方で同じキャップIDで異なるキャップ名が登録されている場合はボード設定が優先されます。

■バージョンアップ方法■
まずメンテナンス告知を適当に編集してから実行してください。
改造したい所が有れば変更し、必要ならエラーメッセージをカスタマイズします。
その後、ファイルをftpソフトで上書きアップロードします。
初期設定→ボード初期設定　で新しく追加された設定項目の初期値を定義します。
メンテナンス告知を解除すると旧バージョンの規制ファイルを変換、新規ボード設定の更新、不要な
ファイルの削除を実行します。
後はボチボチと新機能をテストしつつ導入してみて下さい。
規制を含め新しい設定をメンテナンス告知解除の前にやっておいても特に問題は有りません。

■エラーメッセージ・エラーログ■
test/sub/error.cgiというファイルに記述してあります。このファイルを編集する事でエラーメッセージ
がカスタマイズできます。現バージョンでは書き込み時のエラーのみですが、いずれは閲覧時のエラーも
追加する予定です。
書式は

エラー番号<>ログ用メッセージ<>投稿者用メッセージ

となっています。
ログ用メッセージが無い場合はエラーログに記録されません。

エラーログは現バージョンからボード単位で設定した規制もサーバーのログに記録されます。
サーバーで設定された規制もボードのログに記録されます。
初期設定→エラーログの記録
ボード設定変更→エラーログの記録
でそれぞれログを記録するか否かが選択できます。
１人で管理する場合はボードのログはオフにしていた方が良さそうです。

■.htaccessの利用■
初期設定→掲示板設定→.httaccessの利用をするを選択します。
.htaccessが何か分からないという方はのは検索して調べて下さい。一部のレンタルサーバーでは
.htaccessの利用が出来なかったり、制限が有ったり、禁止されてたりしますので、サーバーの
マニュアルをよく読んで利用をするかしないかを決めて下さい。メニューがグレーになっている部分が
.htaccessを利用するに設定すると有効になります。
.htaccessは設定を間違うと管理者ページにもアクセスできなくなる場合が有りますので、その場合は
ftpソフトでスクリプトのインストールしてあるディレクトリから.htaccessを削除してください。
「.htaccess」の利用を「する」から「しない」に変更してもこのスクリプトで定義した.htaccessが
削除される訳ではありません。

●自動アクセス制限
.htaccessのアクセス制限は単に投稿が出来なくなるだけでなく、閲覧さえも出来なくなります。
主にスパムやプロキシ経由の投稿を排除する為に使います。
ここで定義する条件に引っ掛かった対象は.htaccessにIPアドレスが記録されアクセスが制限されます。
なおリモートホスト規制に引っ掛かっても記録するのはIPアドレスになります。リモートホスト規制に
引っ掛かったのならリモートホストを.htaccessに記録すれば良さそうなものですが、リモートホストの
取得はサーバーの負荷が大きいのでこういう仕様になっています。後述の「その他.htaccess設定」に
リモートホストを記述する事で、リモートホストを.htaccessで規制する事もできますが、非推奨として
おきます。

【投稿ボタン文字送信不備】
 投稿フォームの「書き込み」ボタンの文字列が正しく送られていない場合にアクセスを制限します。
 これに引っ掛かるのは99.9%スパムです。稀に未知の２ちゃんねる専用ブラウザが引っ掛かる可能性が
 無くも無いですが、それは２ちゃんねる専用ブラウザの方で対処するべき問題です。

【スレッド番号スレッドタイトル送信不備】
 通常のレス書きではスレッドタイトル無しでスレッド番号が送信されます。また通常のスレ立てでは
 スレッド番号無しでスレッドタイトルが送信されます。スレッド番号とスレッドタイトルの両方とも
 送られて来ない場合や、両方送られて来る場合がこれに該当します。これも99.9%スパムと考えて良い
 でしょう。制作途中の２ちゃんねる専用ブラウザの動作テストでこういう状況が出る可能性は無きに
 しも非ずですが、知った事ではありません。

【IPからリモートホストが取得できない】
 今までリモートホスト規制でnoname_hostとしていた物ですね。前述したようにリモートホストの取得は
 結構サーバーに負荷を掛けます。リモートホストが取得出来ない場合は更に負荷が大きくなります。
 またリモートホストが取得出来ないサーバーはプロキシかスパムの可能性が高いです。

【リモートホストからIPが取得できない】
 auの一部のサーバーでリモートホストからIPが取得できない場合が有りますが対策してあります。
 大部分はスパムですが、まれに職場や学校のサーバーからの投稿がこれに引っ掛かる場合があります。
 プロバイダ経由の投稿がこれに引っかかる事はまず有りません。

【プロキシ特有の環境変数が有るサーバー】
 プロキシ経由の投稿を排除したい場合はこれを設定します。閲覧まで制限する必要が無い場合はIPやID
 の規制にpcpを設定しておけば良いでしょう。
 この規制では一部のスパムが引っ掛かりますが、携帯変換サイトやサーバーを経由する携帯用ブラウザ
 が引っ掛かる場合も有ります。この規制に引っ掛かっても代替の閲覧や投稿の手段は有りますが、
 閲覧投稿の多様性をとるかどうかを考えて設定してください。

【サーバーを経由するブラウザ】
 現在この設定は実装されていません。チェックをしてもしなくても関係有りません。

【外部サイトを利用した規制】
 規制設定の規制端末設定の「外部サイトを利用した規制」に引っ掛かったIPのアクセスを制限します。

【リファラ規制】
 リファラ規制をするに設定していた場合にこのチェックを付けているとアクセス制限になります。
 リファラは簡単に偽装できる上に、セキュリティソフトの設定によっては送られて来ない場合が有ります。
 リファラを規制すること自体に疑問が有ったりしますが、お好みで設定してください。

【リモートホスト規制】
 規制設定の規制端末設定の「規制するホスト名」に引っ掛かったIPのアクセスを制限します。

【IPアドレス規制】
 規制設定の規制端末設定の「投稿禁止IPアドレスまたは端末ID」に引っ掛かったIPのアクセスを制限します。
 リモートホストの規制とIPアドレスの規制はクッキーに記録したIPやリモートホストも規制対象となります
 が、アクセス制限の対象にはなりません。

●利用しないドメイン・リダイレクトディレクトリ・統一URL
このスクリプトはクッキーを利用している関係で複数のurlからアクセスされるのは好ましくありません。
複数のurlからアクセスされてもurlを変更して１つのurlに統一する場合に使います。
http://exsample.com/bbs/
http://www.exsample.com/bbs/
という２つのurlから掲示板がアクセスできるとします。
urlをhttp://www.exsample.com/bbs/に統一したい場合は
利用しないドメインをexsample.com
統一URLをhttp://www.exsample.com/bbs/
とします。
逆にhttp://exsample.com/bbs/に統一したい場合は
利用しないドメインをwww.exsample.com
統一URLをhttp://exsample.com/bbs/
とします。

http://exsample.com/bbs/
http://www.exsample.com/bbs/
http://bbs.exsample.com/
という３つのurlからアクセスできる掲示板でurlをhttp://bbs.exsample.com/に統一したい場合は
リダイレクトディレクトリを/bbs/
統一URLをhttp://bbs.exsample.com/
とします。

なをこの設定は掲示板スクリプトをインストールしているディレクトリより上の階層に対しては効果が
有りませんので、掲示板と別のコンテンツが有るサイトでも問題は起こらないはずです。

●その他.htaccess設定
上の設定の他に.htaccessに設定したい項目が有る場合はここに記述します。
.htaccessに記録する順番としては、urlの変換→ここの記述→アクセス制限IPとなります。

■ボード設定の新機能■
・板の書き込み制限・スレ立て制限にレベルが選択できるようになりました。
・投稿記録保持件数
　ここに適当な数値を設定する事で二重投稿やマルチポスト規制や投稿間隔規制ができます。
　どれくらいの数値を設定するのが妥当かは試行錯誤段階ですが、50くらいで良いのではないでしょうか。
・投稿可能件数
　１つの端末から投稿できる回数を制限します。
　例えば投稿記録保持件数が30でここの設定が20の場合、投稿数20件に達した人は他の人が10件以上投稿
　しないと投稿できなくなります。利用者の少ない掲示板では設定しなくても良いかもしれません。
　0や空白を設定しておくと制限が無しになります。
・スレ立て可能件数
　投稿可能件数と同様の制限をスレ立てに対して行います。0で無制限です。
・連続投稿禁止時間（秒）
　前回の投稿からここに設定した時間経過しないと投稿できなくします。この制限に引っ掛かると、
　１回目は残り時間だけ待つようにメッセージが出ます。にも拘わらず無視して投稿すると更に設定秒数
　投稿できなくなります。それも無視すると設定秒数の２倍、以後残り時間に設定秒数×無視した回数を
　加算した時間投稿できなくなります。

■正規表現■
規制の設定で行頭にreg:を付ける事で正規表現による記述ができるようになりました。
正規表現に付いては説明が大変なので検索等して調べて下さい。分からない場合は具体的にしたい事を
明確にしてサポート掲示板で質問してください。
reg:は大文字小文字を区別しませんので、REG:としてもかまいません。

■規制除外設定■
規制にnotやandを設定する事により、規制対象をしぼる事ができます。
例えば投稿禁止IPアドレスまたは端末IDに
reg:^pcp not rh=\.opera-mini\.net$
と設定するとプロキシ特有の環境変数を規制するがリモートホストがopera-mini.netなら規制しない。
リモートホスト規制を↓とすると
.ocn.ne.jp and ua=MSIE
この場合はOCNでIEからの投稿だけが規制されます。
ちなみにＮＧワードに
reg:. and rh=\.ocn\.ne\.jp$
と設定したりすると、ocnを全規制できたりして、ＮＧワードの設定でサーバー規制ができるという
規制を分ける意味が有るのかどうか疑問が出てくる機能だったりします。

またandやnotは複数設定できます。例えばＮＧワードに
テスト not ua=MSIE not ua=Android
と設定するとIEかAndroid端末からしか「テスト」という単語が投稿できなくなります。

除外設定に指定できる項目は次の通り

rh= リモートホスト
ip= IPアドレス(１０進、１６進、サブネットマスク表記)
id= 端末ID(携帯の固有IDやクッキーに記録したID他)
ua= ユーザーエージェント(ブラウザ情報)
title= スレ立て時のスレッドタイトル
board= 投稿対象ボードディレクトリ
name= 投稿時の名前欄
mail= 投稿時のメール欄
mess= 投稿時の文章欄
info= 投稿後のレスヘッダの日時や投稿IDが記録される部分
level=数値 レベルが数値に等しい場合
level>数値 レベルが数値より大きい場合
level<数値 レベルが数値より小さい場合
level>=数値 レベルが数値以上の場合
level<=数値 レベルが数値以下の場合

andやnotの左右には半角スペースが必要ですが、=の左右には入れないでください。入れると半角スペース
も規制除外の調査対象になります。

規制除外設定をすると、andの条件にヒットしない、notの条件にヒットする場合は規制のチェックを
しません。よって外部サイトを利用した規制などの重い規制に国内のプロバイダを除外する設定をして
おくと便利かもしれません。

■IPアドレス規制■
IPアドレスの記述に１０進数表記(一般的な記述方法)やサブネットマスクの記述ができるようになりました。
サブネットマスクに付いての詳細は検索でもして調べてもらうとして、88.160.0.0/11と記述すると
88.160.0.1～88.191.255.254までが対象になるという、今までの１６進記述より細かい設定ができます。

■外部サイトを利用した規制■
前バージョンまでは掲示板設定でチェックするようになっていたため、スパムチャンプルー等の
規制は設定方法が同じにも関わらず増やせませんでした。
現バージョンからはdnsbl形式ならurlを設定するだけで導入できます。
ただこの規制を導入すると重くなるので国内のプロバイダ以外に限定して導入した方が良いと思います。
reg:niku.2ch.net not rh=\.jp$ not rh=\.bbtec\.net$
↑BBQを国内のプロバイダ以外に限定して適用する例。

調べた範囲で設定できるdnsblは次の通り

dnsbl.spam-champuru.livedoor.com
スパムチャンプルー、ライブドアしたらばで使われている規制です。BBQよりプロキシに対する防御が弱い
ようです。

niku.2ch.net
BBQ、２ちゃんねるで使われているプロキシ規制です。Torを含む大部分のスパムはこれで弾けるようですが
完全という訳では有りません。他の規制と組み合わせると効果的です。

torexit.dan.me.uk
遠隔操作ウィルスで有名になった匿名化プロキシTorに対する規制です。Torに対する効果は有るようです。

bbx.2ch.net
２ちゃんねるのコピペ爆撃に対する規制です。設定すると巻き添えが多く発生するので非推奨です。
国内のプロバイダ以外に限定して使うのは良いかもしれません。

all.rbl.jp
http.dnsbl.sorbs.net
zen.spamhaus.org
b.barracudacentral.org
bl.spamcop.net
主にメールに対するスパムの規制です。掲示板の規制にも効果が有るかもしれませんが、国内の
プロバイダに対しては巻き添えが発生する恐れが有るので非推奨です。国内のプロバイダ以外に
対して使うのは良いかもしれません。

　外部サイトを利用した規制はBBQが一番強力と思われますが、Tor規制は未知数です。またTor以外の
スパムは自動アクセス制限の「投稿ボタン文字送信不備」「スレッド番号スレッドタイトル送信不備」
「IPからリモートホストが取得できない」「リモートホストからIPが取得できない」「プロキシ特有
の環境変数が有るサーバー」のチェックを入れておくとBBQを使わなくても大部分が弾けます。
　これらの自動アクセス制限と、torexit.dan.me.ukまたはniku.2ch.netを国内のプロバイダ以外に
限定して設定し、自動アクセス制限の「外部サイトを利用した規制」にチェックを入れておくと怪しい
サーバーからの投稿の大部分を拒否できると思われます。

■ユーザーエージェント■
ユーザーエージェントが規制できるようになりました。果たして規制する意味が有るのかどうかは謎
ですが、携帯の固有IDを規制してもフルブラウザから投稿してくる場合は有効かもしれません。
ユーザーエージェントは偽装が簡単ですが、変更できないブラウザも有ったりするので臨機応変に
設定してください。

■リライトワード■
投稿された文章で不適切な単語を伏字にする目的で導入しましたが、色々と遊べる機能です。
行頭に対象となる項目を記述しなければ、投稿の文章欄の文字を変換します。

馬鹿 = ○○
と設定すると「馬鹿野郎」が「○○野郎」に変換されます

orを設定する事で一体多や多対一、多対多の変換ができます。

馬鹿 or アホ or 池沼 = ○○
と設定すれば「お前は馬鹿」も「お前はアホ」も「お前は○○」に変換されます

馬鹿 or アホ or 池沼 = ○○　or △△ or ××
と設定すれば前の例の○○の部分が○○か△△か××に置き換えられます

正規表現が使えるので、
reg:馬鹿|アホ|池沼 = ○○　or △△ or ××
としても微妙な違いは有りますが大体同じ事ができます。

馬鹿 = ○○　or △△ or ××
という設定もできます。

ShiftJISで運用している場合、まれに正規表現が誤動作をする場合が有るので、状況によって
使い分けて下さい。ちなみに正規表現を使わない方が若干置き換え速度が速いようです。

リライトワードの行頭に次の項目を設定すると文章欄以外にも使えます。

title= スレ立て時のスレッドタイトル
name= 名前欄
mail= メール欄
mess= 文章欄
info= 投稿後のレスヘッダの日時や投稿IDが記録される部分
all= 上記のinfo以外

name=mail=などと設定する事により複数項目を対象にできます。

置き換え後の文字列に次の文字列を設定する事で端末情報を表示できます。
!ipaddress IPアドレス
!remotehost　リモートホスト
!useragent　ユーザーエージェントから携帯固有IDを取り除いた物
!level　レベルの数値
!Level　レベルの数値に削除投票権などの情報を追加した物
!termTrip　端末IDまたはIPアドレスから生成したトリップ(前バージョンの!nanja)
!rnd数値　0から数値-1の範囲の値をとる乱数

現バージョンからfusianaさんや!omikuji等の機能を削除しましたので、必要な場合はこれらの
設定と除外設定を組み合わせてリライトワードで定義してください。

ほぼ前バージョンと同じ機能(!damaを除く)
name=fushianasan = </b>(!ipaddress)<b> not name=★
name=fusianasan = </b>!remotehost<b> not name=★
name=!ninja = </b>Sweeper【Lv=!Level】<b>
name=!omikuji = </b>【!omikuji】<b> and info=/01(
name=!omikuji = 大吉 or 小吉 or 中吉 or 小吉 or 末吉 or 吉 or 凶 or 末吉 or 大凶 or はずれ and info=/01(
reg:name=$ = </b> !termTrip<b> and name=!nanja not name=◆
name=!nanja =

ほぼ前バージョンと同じお年玉(!dama)
name=!dama = </b>【!rnd5000!dama円】<b> and info=/01/01
reg:name=(?<=\d)\d\d!dama = 00 and info=/01/01
name=!dama = and info=/01/01

シンプルなお年玉(!dama)
name=!dama = </b>【!rnd40000!円】<b> and info=/01/01

凝ったお年玉(!dama)
name=!dama = </b>【!rnd100000!dama円】<b> or </b>【!rnd1000.!rnd10!rnd10ドル】<b> or </b>【!rnd10000!damaペソ】<b>  or </b>【!rnd10000!dama元】<b> and info=/01/01
reg:name=(?<=\d)\d\d!dama = 00 and info=/01/01
name=!dama = and info=/01/01

以下適当に

名前欄にランダムな0～999までの数値を表示(!random)
name=!random = </b>!rnd1000<b>

キャップを使わない名前欄の管理人を変更する
name=管理人 = 菅理人 or 管理入 or 管直人 not name=★

名前、メール欄の全角＃以降を消去してトリップやキャップ漏れを防ぐ
reg:name=mail=＃.+$ = ＃

ランダム名無し(名無し設定が「名無しさん」の場合)
reg:name=^名無しさん$ = 名無しの権兵衛 or ７７４さん or 日本むかし名無し

レベルによって名前欄に称号を追加する
reg:name=$ = </b>序ノ口<b> and level>=1 and level<=2
reg:name=$ = </b>序二段<b> and level>=3 and level<=5
reg:name=$ = </b>三段目<b> and level>=6 and level<=9
reg:name=$ = </b>幕下<b> and level>=10 and level<=12
reg:name=$ = </b>十両<b> and level>=13 and level<=16
reg:name=$ = </b>前頭<b> and level>=17 and level<=20
reg:name=$ = </b>小結<b> and level>=21 and level<=25
reg:name=$ = </b>関脇<b> and level>=26 and level<=29
reg:name=$ = </b>大関<b> and level>=30 and level<=39
reg:name=$ = </b>横綱<b> and level>=40

７時７分７秒の投稿には名前欄の先頭にフィーバーを挿入
reg:name=^ = </b>フィーバー<b> and info=07:07:07

曜日を英語にする
info=(日) = (Sun)
info=(月) = (Mon)
以下略

毎日が日曜日
reg:info=\(.+\) = (日)

毎日がエイプリルフール
reg:info=/\d\d/\d\d = /04/01
ボードを限定する場合はボードの規制設定に記述するか
reg:info=/\d\d/\d\d = /04/01 and board=uso
のように対象ボードを設定します

２行目以降に!agentだけ書かれた行が有ればユーザーエージェントに変換
reg:<br>!agent(?=<br>|$) = <br>!useragent

ジャァァァップとかジャーーップが文章欄に有ると端末情報を晒す
reg:$ = <br><hr>(!ipaddress)!remotehost<br>!useragent and mess=ジャ[アァー]+ップ
ジャップも含める場合はこちら
reg:$ = <br><hr>(!ipaddress)!remotehost<br>!useragent and mess=ジャ[アァー]*ップ

レベルアップメッセージ
現バージョンからレベルが上がったら文章欄の末尾に
<br>levelup:数値:
という文字列が追加され、リライトワードで変更しなければ消去されるようになりました。

↓のような設定をリライトワードにする事でレベルアップメッセージを追加できます。
mess=!levelup:40: = レベルが最大値になった
reg:mess=!levelup:\d+: = レベルが上がった

レベルが上がるたびにメッセージが出るのもナニなので、適度に数値を指定する方が良いかもしれません。
mess=!levelup:15: = レベル!levelになった、レス削除投票権を取得した
とか、まだ削除投票機能は実装していませんけど。

リライトワードは色々と遊べる機能だと思いますが、やりすぎると鬱陶しくなりそうなので程々にして
おきましょう。

■ＮＧワード■
ＮＧワードもリライトワード同様対象を選択できるようになりました。

title= スレ立て時のスレッドタイトル
name= 名前欄
mail= メール欄
mess= 文章欄
info= 投稿後のレスヘッダの日時や投稿IDが記録される部分
all= 上記のinfo以外

infoをＮＧワードで規制する意味は全く有りませんが、リライトワードと同じサブルーチンを使って
いるので、まぁそういう事です。

ＮＧワードはリライトワードと違いorが使えません。
複数の単語を１行で規制したい場合は正規表現を使います。
例
reg:馬鹿|アホ|間抜け|池沼|糖質

■アクセス制限設定■
自動アクセス制限によって.htaccessに記述された制限対象を編集できます。
リモートホストや備考は分かりやすさの為に記述して有りますので、適当に変更して構いません。
IPグループが同じ場合はサブネットマスクの形式にして行を減らしたりしましょう。
最下行の空白部分に記述すればIP規制を追加できます。一度に追加できるのは１件だけになります。

